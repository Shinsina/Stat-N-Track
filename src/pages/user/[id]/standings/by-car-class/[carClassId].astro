---
import { connectToDatabase } from "$lib/mongodb";
import StandingsLayout from "$lib/layouts/standings.astro";
import userIds from "$lib/utils/user-ids";
import type { UserIdCarClassIdsMapping } from "$lib/types";
export async function getStaticPaths() {
  const dbConnection = await connectToDatabase();
  const db = dbConnection.db;
  const collection = db.collection("standings");
  const mappings: Array<UserIdCarClassIdsMapping> =
    await Promise.all(
      userIds.map(async (userId) => ({
        userId,
        carClassIds: await collection.distinct("car_class_id", {
          "season_driver_data.cust_id": Number(userId),
        }),
      }))
    );
  return mappings
    .map((mapping) => {
      const { userId, carClassIds } = mapping;
      return carClassIds.map((carClassId) => ({
        params: { id: userId, carClassId },
      }));
    })
    .flat();
}

const { id, carClassId } = Astro.params;
const dbConnection = await connectToDatabase();
const { db } = dbConnection;
const collection = db.collection("standings");
const standingsResults = await collection
  .find({
    "season_driver_data.cust_id": Number(id),
    car_class_id: String(carClassId),
  })
  .sort({ season_id: -1 })
  .toArray();
---

<StandingsLayout {id} {standingsResults} />
